// [START declaration]
syntax = "proto3";
// import "google/protobuf/any.proto";
import "google/protobuf/any.proto";
import "google/protobuf/timestamp.proto";
import "xnormal.proto";
import "ymat.proto";
package y3d; // 
// [END declaration]

// [START csharp_declaration]
option csharp_namespace = "y3d.e";
// [END csharp_declaration]

// [START messages]


message YPoint3 {
	float x = 1;
	float y = 2;
	float z = 3;
}

message YBox3 {
	YPoint3 pmin = 1;
	YPoint3 pmax = 2;
}

message YResource {
  string rid=1;
  enum ResourceType {
    BINARY=0;
    IMAGE=1;
    FLATBUFFER=2;
    PROTOBUF=3;
    CAPNP=4;
  }
  ResourceType rtype=2;
  string link=3;
}

message YLight {
  repeated float diffuse = 3;
  repeated float specular = 4;

  float intensity = 5;
  float range = 6;
  float angle = 7;
  float exponent = 8;

  repeated string excludedMeshesIds = 9;
  repeated string includedOnlyMeshesIds = 10;
}


message YCamera {
  repeated float rotation=3;
  repeated float target=4;
  float fov=5;
}

message YMesh {
  int32 num_faces = 1;
  YBox3 bbox = 2;
  enum MeshType {
    Unknown=0;
    Editable_Mesh=1;
    Editable_Poly=2;
    Box=3;
    Sphere=4;
    GeoSphere=5;
    Cylinder=6;
    Tube=7;
    Torus=8;
    Pyramid=9;
    Teapot=10;
    Plane=11;
    Target=12;
    Cone=13;
  }
  YResource res = 3;
  enum XrefStatus {
    ORIGINAL=0;
    XREF_HIGHT=1;
    XREF_LOW=2;
    XREF_LOW_DISPLAY=3;
    BOX=4;
    MERGED=5;
    FINAL=6;
  };
  XrefStatus xstatus=5;
  MeshType mtype=6;
  string vername=7;
}


// ------------------------------ 
enum ObjectType {
  GEOMETRY=0;
  LIGHT=1;
  CAMERA=2;
  SHAPE=3;
  OTHER=4;
}

enum GVerType {
  NO_VER=0;
  ORIGINAL=1;
  IN_BAKE=2;
  STANDARD=3;
}
  
message YObject {
  string name = 1;
  YPoint3 pos = 3;
  map<string,google.protobuf.Any > extra = 5;
  ObjectType otype=6;
  repeated string tags=7;
  int32 cate_id=8;
  oneof data {
    YLight light=10;
    YCamera camera=11;
    YMesh mesh=12;
  }
  TestObject ver_obj=13;
}

message YArea {
  string name = 1;
  repeated YGroup groups = 2;
  repeated YObject objs = 3;
  map<string,YGroupVer> gvers=6;
}

message YAreaList {
  repeated YArea areas=1;
}

message YLayer {
  string name=1;
  repeated YGroup groups = 2;
}

message YGroup {
  string name = 1;
  repeated YObject objs = 2;
  repeated YGroup children = 3;
  GVerType gv_type=4;
  repeated string xref=5;
}

message YGroupVer {
  string vname=1;
  YGroup groupData=2;
  int32 step=3;
}

message FilterView {
  ObjectType otype = 1;
  int32 face_range = 2;
  string search=3;
  int32 aid=4;
}
// ------------------------------ Optimize highpoly by faces count
message FRangeItem {
  int32 f_start=1;
  int32 f_end=2;
  YColor fr_color=3;
  float ratio=4; // lowpoly ratio
  bool has_xref=5;
}
// message FRangeList {
//   repeated FRangeItem fr=1;
// }

message OptimizeOptions {
  bool use_range=1;
  repeated FRangeItem fr=2;
  int32 min_hpoly=3;
  int32 out_range_count=4;
}
// ------------------------------ Common Params

message ResultReply {
  bool error=1;
  string message = 2;
}

message EmptyParam {}

message RenameParam {
  bool use_select=1;
}

message Make4TestParam {
  string oname=1;
  repeated ELowpoly lowpoly=2;
}

message TestOParam {
  int32 id = 1;
  string oname=2;
  float low_ratio=3;
}

message OptimizeParam {
    float ratio =1;
}

message BatchOptimizeParam {
    float ratio =1;
    string folder=2;
    string filename=3;
}
message StringParam {
    string str=1;
}

message TestParam {
  string test_name=1;
  google.protobuf.Any anything=2;
}


// ------------------------------ Event
message YEvent {
  oneof event {
    ENone noevent = 1;
    ESelect select = 2;
    EMove move = 3;
    ERotate rotate = 4;
    EDelete del = 5;
    ESelectMany select_many=6;
    EIsolate isolate=7;
  }
}

message ENone {}

message ESelect {
  string name = 1;
  bool isolate = 2;
}

message ESelectMany {
  repeated string name = 1;
  bool isolate = 2;
}

message EMove {
  repeated float point=1;
}

message ERotate {
  repeated float rotate=1;
}

message EDelete {
  string name = 1;
}

message EIsolate {
  string name = 1;
  bool endIsolate=2;
}

message ResponseEvent {
  bool error = 1;
  string msg = 2;
}

// ------------------------------  Unwrap

message EUnwrap {
  string oname =1;
  int32 channel=2;
  oneof setting {
    MaxUnwrap max3d = 3;
    BlenderUnwrap blender = 4;
  }
}
message BlenderUnwrap {}
message MaxUnwrap {
  float angle = 1;
  float spacing=2;
}

// ------------------------------ Packing
message EPacking {
  string oname = 1;
  string uvname = 2;
  int32 tile_Size=3;
  oneof pack {
    Pack3DMax packmax=4;
    PackRect packrect = 5;
  }

}
message PackRect {
  int32 density=1;
  float padding=2;
}
message Pack3DMax {
  int32 numTile=1;
  bool normalize=2;
  bool rotate_clusters=3;
  bool fill_holes=4;
  bool padding=5;  
}
// ------------------------------ Low Poly
message ELowpoly {
  string oname = 1;
  oneof lowtype {
    LPoly3DMax lp_3dmax=2;
    LPolyBlender lp_blender=3;
    LPolyMeshlab lp_meshlab=4;
  }
}
message LPoly3DMax {
  float vertex_percent=1;
  int32 vertex_count=2;
  enum OpMode {
    CRUNCH_BORDERS=0;
    PROTECT_BORDERS=1;
    EXCLUDE_BORDERS=2;
  }
  OpMode optimization_mode=3;
  enum NormalMode {
    CRUNCH_NORMALS=0;
    PROTECT_NORMALS=1;
    EXCLUDE_NORMALS=2;
  }
  NormalMode normals=4;
  bool favor_compact_faces=5;
  bool prevent_flipped_normals=6;
  bool lock_vertex_position=7;
}
message LPolyBlender {
  float ratio=1;
}
message LPolyMeshlab {
}

// ------------------------------ Normal
message ENormal {
  string oname = 1;
  string lowpoly=2;
  string highpoly=3;
  uint32 tex_size=4;
  string out_tex=5;
  oneof ntype {
    Normal3DMax normal_3dmax=6;
    xnormal.Settings normal_xnormal=7;
  }
}

message Normal3DMax {
}

// ------------------------------ Project , System Setting ...

message ProjectInfo {
  string pname = 1;
  string project_path=2;
  google.protobuf.Timestamp ts=3;
  OptimizeOptions optimize_ops=5;
  repeated FilterView fview=6;
  float optimize_ratio = 7;
  string original_path=8;
  repeated YWorker workers=9;
  // YAreaList alist=6;
}

message SettingData {
  string aset_name=1;
  map<string,google.protobuf.Any> data=2;
}

message PSetting {
  SettingData extra=1;
  int32 max_recent = 2;
}

message YSystem {
  string working_folder=1;
  ProjectInfo default_info = 2;
  PSetting default_setting = 3;
  repeated ProjectInfo projects=4;
  map<string,WorkerApp> apps=5;
  YMasterServer master_server=6;
}

message NewProjectParam {
  string fname=1;
  string folder=2;
  string project_path=3;
}

message ResponseNProject {
  ProjectInfo pInfo=1;
  YAreaList yal=2;
  string err=4;
}


// ------------------------------ Task,Worker,Job...
message YJobAction {
  oneof action {
    EUnwrap unwrap = 1;
    EPacking pack = 2;
    ELowpoly lowpoly = 3;
    ENormal bake_normal = 4;
  }  
}
message YItemMesh {
  YMat bake_mat=1;
  YBaseMap map=2;
  YMesh mesh=3;
  repeated YMesh meshes=4;
}

message TestObject {
  bool active=1;
  YMat original_mat=2;
  string tname=3;
  string oname=4;
  // string name_low=3;
  // string name_high=4;  
  // string name_cage=5;  
  // string obj_low= 6;  
  // string obj_high=7;  
  // string obj_cage=8;  
  string save_path=9;
  YItemMesh out=10;
}

message YJob {
  string jname = 1;
  repeated YJobAction act=2;
  YObject obj = 3;
  repeated YObject objs = 4;
  YItemMesh out=5;
  repeated TestObject tests=7;
}

message YJobList {
  repeated YJob jobs=1;
}

message YWorker {
  int32 wid=1;
  string wname=2;
  string ip_address =3;
  
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
    NOT_CONNECT_MASTER=3;
    NO_PROJECT=4;
  }
  ServingStatus status = 5;
}

message YSubWorker {
  int32 sid = 1;
  string sname =2;
  string asset_folder=3;
  YWorker worker = 4;
}

message YMainWorker {
  YSubWorker main_worker = 1;
  repeated YSubWorker workers = 2;
  string working_project = 3;
}


message YWorkerList {
  // YWorker master = 1;
  repeated YWorker workers=1;
}

message YWorkerRequest {
  bool call_in_app=1;
  bool slient=2;
  WorkerApp app=3;
}

message WorkerApp {
  string wname=1;
  string path_run=2;
  string extra=3;
}

message YWorkerResponse {
  // YWorkerList wlist = 1;
  YWorker new_worker=1;
  string error=2;
}

message YMasterServer {
  string mname = 1;
  string address =2;
  int32 port=5;
  string shared_folder = 3;
  repeated YMainWorker main_workers = 4;
}